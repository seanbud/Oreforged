name: Build OreForged

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Build & Package (Using Local Script)
      run: .\package_release.ps1
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OreForged-Windows
        path: OreForged_Windows.zip

  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Build UI
      run: |
        cd ui
        pnpm install
        pnpm build
        
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake ..
        
    - name: Build Game
      run: |
        cd build
        cmake --build . --config Release
        
    - name: Package
      run: |
        mkdir release
        cp build/bin/OreForged release/
        cp -r ui/dist release/ui
        cd release && zip -r ../OreForged_Linux.zip .
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OreForged-Linux
        path: OreForged_Linux.zip

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
        
    - name: Build UI
      run: |
        cd ui
        pnpm install
        pnpm build
        
    - name: Configure CMake
      run: |
        mkdir build
        cd build
        cmake ..
        
    - name: Build Game
      run: |
        cd build
        cmake --build . --config Release
        
    - name: Package
      run: |
        mkdir release
        cp build/bin/OreForged release/
        cp -r ui/dist release/ui
        cd release && zip -r ../OreForged_macOS.zip .
        
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OreForged-macOS
        path: OreForged_macOS.zip

  release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/OreForged-Windows/OreForged_Windows.zip
          artifacts/OreForged-Linux/OreForged_Linux.zip
          artifacts/OreForged-macOS/OreForged_macOS.zip
